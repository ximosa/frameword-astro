---
interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
---

<!-- Botón flotante para abrir TOC -->
<button
    id="toc-button"
    class="fixed bottom-6 right-6 z-40 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center group"
    aria-label="Tabla de contenidos"
>
    <svg
        class="w-6 h-6 transition-transform group-hover:scale-110"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
    >
        <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h7"></path>
    </svg>
    <span
        class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center font-bold"
    >
        {headings.length}
    </span>
</button>

<!-- Modal TOC -->
<div
    id="toc-modal"
    class="fixed inset-0 z-50 hidden"
    aria-labelledby="toc-title"
    role="dialog"
    aria-modal="true"
>
    <!-- Backdrop -->
    <div
        id="toc-backdrop"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
    >
    </div>

    <!-- Panel del TOC -->
    <div class="fixed inset-y-0 right-0 flex max-w-full pl-10">
        <div
            id="toc-panel"
            class="w-screen max-w-md transform transition-transform duration-300 ease-out translate-x-full"
        >
            <div
                class="flex h-full flex-col bg-white dark:bg-gray-900 shadow-2xl"
            >
                <!-- Header -->
                <div
                    class="px-6 py-4 border-b border-gray-200 dark:border-gray-700"
                >
                    <div class="flex items-center justify-between">
                        <h2
                            id="toc-title"
                            class="text-lg font-semibold text-gray-900 dark:text-white"
                        >
                            Tabla de Contenidos
                        </h2>
                        <button
                            id="toc-close"
                            class="rounded-md p-2 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                            aria-label="Cerrar"
                        >
                            <svg
                                class="h-6 w-6"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Lista de contenidos -->
                <nav class="flex-1 overflow-y-auto px-6 py-4">
                    <ul class="space-y-1">
                        {
                            headings.map((heading) => (
                                <li
                                    style={`margin-left: ${(heading.depth - 2) * 1}rem`}
                                    class="group"
                                >
                                    <a
                                        href={`#${heading.slug}`}
                                        data-toc-link
                                        class="block py-2 px-3 text-sm text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md transition-colors"
                                    >
                                        <span class="flex items-center gap-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-gray-400 dark:bg-gray-600 group-hover:bg-blue-600 dark:group-hover:bg-blue-400 transition-colors" />
                                            {heading.text}
                                        </span>
                                    </a>
                                </li>
                            ))
                        }
                    </ul>
                </nav>

                <!-- Footer con info adicional -->
                <div
                    class="px-6 py-4 border-t border-gray-200 dark:border-gray-700"
                >
                    <p
                        class="text-xs text-gray-500 dark:text-gray-400 text-center"
                    >
                        {headings.length}
                        {headings.length === 1 ? "sección" : "secciones"} en este
                        artículo
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function setupTOC() {
        const button = document.getElementById("toc-button");
        const modal = document.getElementById("toc-modal");
        const panel = document.getElementById("toc-panel");
        const backdrop = document.getElementById("toc-backdrop");
        const closeBtn = document.getElementById("toc-close");
        const tocLinks = document.querySelectorAll("[data-toc-link]");

        if (!button || !modal || !panel || !backdrop || !closeBtn) return;

        // Función para abrir el modal
        function openTOC() {
            modal.classList.remove("hidden");
            setTimeout(() => {
                panel.classList.remove("translate-x-full");
            }, 10);
            document.body.style.overflow = "hidden";
        }

        // Función para cerrar el modal
        function closeTOC() {
            panel.classList.add("translate-x-full");
            setTimeout(() => {
                modal.classList.add("hidden");
                document.body.style.overflow = "";
            }, 300);
        }

        // Event listeners
        button.addEventListener("click", openTOC);
        closeBtn.addEventListener("click", closeTOC);
        backdrop.addEventListener("click", closeTOC);

        // Cerrar con ESC
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && !modal.classList.contains("hidden")) {
                closeTOC();
            }
        });

        // Cerrar al hacer click en un enlace y hacer scroll suave
        tocLinks.forEach((link) => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                const href = link.getAttribute("href");
                if (!href) return;

                const targetId = href.replace(/^#/, "");
                const targetElement = document.getElementById(targetId);

                if (targetElement) {
                    closeTOC();
                    // Esperar a que el modal se cierre completamente y el overflow se restaure
                    setTimeout(() => {
                        const headerOffset = 80;
                        const elementPosition =
                            targetElement.getBoundingClientRect().top;
                        const offsetPosition =
                            elementPosition + window.scrollY - headerOffset;

                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth",
                        });
                    }, 350);
                }
            });
        });

        // Highlight del enlace activo basado en scroll
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute("id");
                        tocLinks.forEach((link) => {
                            const href = link.getAttribute("href");
                            if (href === `#${id}`) {
                                link.classList.add(
                                    "!text-blue-600",
                                    "dark:!text-blue-400",
                                    "!bg-blue-50",
                                    "dark:!bg-blue-900/20",
                                );
                            } else {
                                link.classList.remove(
                                    "!text-blue-600",
                                    "dark:!text-blue-400",
                                    "!bg-blue-50",
                                    "dark:!bg-blue-900/20",
                                );
                            }
                        });
                    }
                });
            },
            {
                rootMargin: "-80px 0px -80% 0px",
            },
        );

        // Observar todos los headings
        document
            .querySelectorAll("h2[id], h3[id], h4[id]")
            .forEach((heading) => {
                observer.observe(heading);
            });
    }

    // Ejecutar en carga inicial y en navegaciones de Astro
    document.addEventListener("astro:page-load", setupTOC);
</script>

<style>
    /* Animación suave para el botón */
    #toc-button {
        animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Scroll suave para toda la página */
    html {
        scroll-behavior: smooth;
    }
</style>
